!function(a,b){"use strict";function d(a){return[].slice.call(a||[])}function e(a){return a.slice()}function f(a){return a}function g(a,b){return function(c){return c.filter(a).reduce(function(a,c){return b(c)?{exact:a.exact.concat([c]),sub:a.sub}:{exact:a.exact,sub:a.sub.concat([c])}},{exact:[],sub:[]})}}var h={},i={},j={fake:function(){var a=function(){this.store={}};return a.prototype={setItem:function(a,b){this.store[a]=b},getItem:function(a){return this.store[a]},removeItem:function(a){delete this.store[a]},clear:function(){this.store={}}},new a}(),local:a.localStorage,session:a.sessionStorage},k=function(a,c,d){"function"!=typeof a&&console.error("wrong parameter");var e=function(){return a.apply(this,arguments),this};e.prototype=Object.create(d===b?Object.prototype:d.prototype),c instanceof Function&&(c=c(e));for(var f in c)e.prototype[f]=c[f];return e},l=function(a){var c=Object.create(null);c.is_monad=!0;var d=function(d){var e=Object.create(c);return e.bind=function(a,c){return a.apply(b,[d].concat(Array.prototype.slice.apply(c||[])))},"function"==typeof a&&(d=a(e,d)),e};return d.method=function(a,b){return c[a]=b,d},d.lift_value=function(a,b){return c[a]=function(){return this.bind(b,arguments)},d},d.lift=function(a,b){return c[a]=function(){var a=this.bind(b,arguments);return a&&a.is_monad===!0?a:d(a)},d},d},m=function(a){return l(function(b,c){return c.length>0?c:(b.bind=a,[])})},n=k(function(){},{lod:function(a){var c=this.hasOwnProperty(a)?this[a]:a;return c===b?b:c===!1?b:c.split===b?new this.$.Comptes(c,this.$):this.$.sync("read",{id:c,$:this.$})},sign:function(){return this.id=""+CryptoJS.SHA1(JSON.stringify(this)),this.id},set_or_default:function(a,c){for(var d in c)this[d]=a[d]===b?c[d]:a[d];return this},save:function(a){return this.$.sync("update",this,a)}}),o=(k(function(a){this.set_or_default(a,{data:"",meta:{},livre:b,id:b,$:b}),this.meta=new o(this.meta),this.id===b&&this.save()},{toJSON:function(){return{data:this.data}},toVSON:function(){return this.data}},n),k(function(a){a&&Object.keys(a).forEach(function(b){this[b]=a[b]}.bind(this))},{concat:function(a){var b=new o(this);return Object.keys(a).forEach(function(c){b.hasOwnProperty(c)?b[c]+="\n"+a[c]:b[c]=a[c]}),b}},Object)),p=function(a,c,f,g,h,i){var j=Math.pow(10,c),l=k(function(c){var e=function(a){[].push.apply(this,a)}.bind(this),f=function(a){[].push.apply(this,a.map(function(a){return Math.round(a*j)}))}.bind(this);if(c===b)return e(Array.apply(null,new Array(a)).map(Number.prototype.valueOf,0));if(c instanceof l)return e(c);if(c instanceof Array&&c.length===a)return c[0]===Number(c[0])?e(c):f(c.map(Number));var g=d(arguments);if(c===Number(c)&&g.length===a)return f(g);throw"don't know how to handle ["+JSON.stringify(c)+"]"},{inEquilibrium:function(){return""===this.toFixed().replace(/0|\./g,"")},reduction:function(){return f.apply(null,d(this))/j},add:function(a){return a instanceof l?new l(this.map(function(b,c){return b+a[c]})):this.add(new l(a))},scale:function(a){return new l(this.map(function(b){return Math.round(b*a)}))},mask:function(a){return new l([].map.call(this,function(b,c){return a[c]*b}))},negate:function(){return new l(g.apply(null,d(this)))},compare:function(a){return h.apply(null,[this,a].map(d))},quotient:function(){return new l(i.apply(null,d(this)))},toFixed:function(){return this.reduction().toFixed(c)},toJSON:function(){return this.map(function(a){return(a/j).toFixed(c)})},zero:function(){return new l(Array.apply(null,new Array(a)).map(Number.prototype.valueOf,0))},unit:function(){var b=function(){return e(this)},c=function(a){return new l(this.map(function(b){return Math.round(b*a*j)}))},d=function(a){return q.Operation(q.want(q.op("param")(a,this,"")))},f=Array.apply(null,new Array(a)).map(Number.prototype.valueOf,0);return e(f).map(function(){return e(f)}).map(function(a,e){a[e]=1;var f=new l(a);return f.toJSON=b,f.scale=c,f.ope=d,f})}},Array);return l.UNITS=l.prototype.unit(),l.ZERO=l.prototype.zero(),l},q=k(function(a){a=a||{},a.storage=a.storage||"",this.storage=j[a.storage in j&&a.storage||"fake"];var b=this.storage.getItem("JStion_HEAD");return b?(this._set_default(JSON.parse(this.storage.getItem(b)).data||a),void this.save()):this._set_default(a)},{toJSON:function(){return{parent:this.parent,e:this.e,entities:this.entities}},_set_default:function(a){this.set_or_default(a,{e:{parent:b,operateurs:{},mouvements:{},operations:{}},entities:{},id:b})},shortify:function(a){return a.map(function(a){return a.id.substr(a.id.indexOf(":")+1,7)}).join(" ")},want:function(a){return new this.promise(a)},save:function(a){var b=null;return a instanceof Function&&(b=a.call(this)),this.parent=this.id,this.sync("update",this),this.storage.setItem("JStion_HEAD",this.id),b},register_class:function(a,b,c){c=c||{},c.instanciable=!!c.instanciable,this[a]=b,c.instanciable&&(h[a]=b)},register_plan:function(a,b,c){i[a]=c,i[b]=c}},n);q.fn=q.prototype,q.fn.DC=new p(2,3,function(a,b){return a-b},function(a,b){return[b,a]},function(a,b){return a[0]>b[0]?-1:b[0]>a[0]?1:a[0]>0?0:a[1]>b[1]?1:b[1]>a[1]?-1:0},function(a,b){return[a-b,b-a].map(function(a){return a>0?a:0})}),q.fn.DC.U_Debit=q.fn.DC.UNITS[0],q.fn.DC.U_Credit=q.fn.DC.UNITS[1],q.fn.DC_P2=new p(2,2,function(a,b){return a-b},function(a,b){return[b,a]},function(a,b){return a[0]>b[0]?-1:b[0]>a[0]?1:a[0]>0?0:a[1]>b[1]?1:b[1]>a[1]?-1:0},function(a,b){return[a-b,b-a].map(function(a){return a>0?a:0})}),q.fn.DC_P2.U_Debit=q.fn.DC_P2.UNITS[0],q.fn.DC_P2.U_Credit=q.fn.DC_P2.UNITS[1],q.fn.aggregate=function(){var a=d(arguments);if("string"==typeof a[0]){var b=a.shift();return function(c){var d=new q.fn.Fragment;return a.forEach(function(a){"function"==typeof a?d=d.add(a(c)):"object"==typeof a&&a instanceof q.Fragment()?d=d.add(a):a>0?d=d.add(c.r_etat(""+a).solde()):0>a&&(d=d.sub(c.r_etat(""+-a).solde()))}),d.simplify(b)}}return function(b){var c=new q.fn.Fragment;return a.forEach(function(a){"function"==typeof a?c=c.add(a(b)):"object"==typeof a&&a instanceof q.Fragment()?c=c.add(a):a>0?c=c.add(b.r_etat(""+a).solde()):0>a&&(c=c.sub(b.r_etat(""+-a).solde()))}),c}},q.fn.ag_mask=function(){var a=d(arguments),b=a.slice(0,1).pop();return a=a.slice(1),function(c){var d=new q.fn.Fragment;return a.forEach(function(a){"function"==typeof a?d=d.add(a(c).mask(b)):"object"==typeof a&&a instanceof q.Fragment()?d=d.add(a.mask(b)):a>0?d=d.add(c.r_etat(""+a).solde().mask(b)):0>a&&(d=d.sub(c.r_etat(""+-a).solde().mask(b)))}),d}},q.fn.promise=k(function(a){this.f=a},{constrain:function(a){return a},resolve:function(a){var b=this,c=b.f(b.constrain(a));return c instanceof Function?c:function(){return b.f(b.constrain(a))}},toJSON:function(){return["want",this.f]}}),q.fn.sync=function(a,c,d){var e,f="";switch(d=d||{},d.success=d.success||function(){},a){case"read":if(c.id===b)return b;if(!c.id)throw console.log(c),console.error("no id in model for method "+a),new Exception("no id in model for method "+a);if(e=this.storage.getItem(c.id),e===b)return b;e=JSON.parse(e),e.type=this[e.type],e.data.id=c.id,e.data.$=this,e=new e.type(e.data);break;case"create":case"update":f=Object.keys(h).filter(function(a){return c instanceof this[a]}.bind(this)),this.storage.setItem(c.sign(),JSON.stringify({type:f,data:c})),e=c;break;case"delete":this.storage.removeItem(c.sign()),e={}}return d.success(e),e},q.fn.op=function(a){return this.e.operateurs[a]||function(){console.log("operateur "+c+" indefini")}},q.fn.create_operateur=function(a,b){return this.e.operateurs[a]=function(c,d,e){var f=function(f){var g=b.apply(d,[f]);if(g instanceof Function){var h=function(a){return[[c].concat(g.apply(d,[a]))]};return h.toJSON=function(){return[[a,c,d.toJSON(),e],f]},h}return[[c].concat(g)]};return f.help=function(){return"string"==typeof e?e:""},f.toJSON=function(){return[a,c,d.toJSON(),e]},f},this.save(),this},q.fn.Fragment=k(function(a){var c=function(a){[].push.apply(this,a)}.bind(this);if(this.single=!1,a===b)return c([]);if(a instanceof q.fn.Fragment)return this.single=a.single,c(d(a));if(a instanceof Array)return c(a);throw console.log(a),"don't know how to handle ["+JSON.stringify(a)+"]"},function(a){return{maybe_empty:m(function(){return new a([])}),toJSON:function(){return[].map.call(this,f)},toVSON:function(){return this.single?[].map.call(this,function(a){return a instanceof Array?[a[0],a[1].toFixed()]:a}):[].map.call(this,function(a){return a instanceof Array?[a[0],a[1].toJSON()]:a})},add:function(c){return c===b?this:new a(d(this).concat(d(c)))},sub:function(a){return this.add(a.negate())},simplify:function(a){return 0===this.length?this:this.reduce(function(a,b){return[a[0],a[1].add(b[1])]},[a,this[0][1].zero()])},negate:function(){return this.map(function(a){return[a[0],a[1].negate()]})},solde:function(){return this.map(function(a){return[a[0],a[1].quotient()]})},map:function(b){return new a([].map.call(this,b))},reduce:function(b,c){return new a([[].reduce.call(this,b,c)])},mask:function(a){return this.map(function(b){return[b[0],b[1].mask(a)]})},single_col:function(a){return this.single=!!a,this}}},Array),q.fn.Operation=function(){var a=function(a){return 0===a.length?0:Math.abs(a.reduce(function(a,b){return a.add(b[1])},a[0][1].zero()).reduction())},c=function(a){return 0===a.length?!0:Math.abs(a.reduce(function(a,b){return a.add(b[1])},a[0][1].zero()).inEquilibrium())},e=l().lift_value("o",function(a,c){return f(c===b?a:c.bind===b?a:a.concat(c.bind(function(a){return a})))}).lift_value("grab",function(a,b){var c=a.filter(function(a){return a instanceof q.fn.promise}).slice(b.length);return 0===c.length?b:b.concat(c.map(function(a){return Number(prompt(a.f.help))}))}).lift_value("toJSON",function(a){return a.slice(0)}).lift_value("compose",function(b,c){return b.reduce(function(b,d){if(d instanceof q.fn.promise){var e=c.shift();e instanceof Function&&(e=a(e(b))),d=d.resolve(e)}return d(a(b)).concat(b)},[])}).method("resolve",function(){var b=d(arguments),e=b.shift(),f={meta:e,mouvement:this.compose(this.grab(b))};if(!c(f.mouvement))throw console.log("non équilibré : "+a(f.mouvement)),console.log(f),new Exception("Ecriture non équilibrée");return new q.fn.Ecriture(f)}),f=function(a){var b=e(a),c=b.resolve.bind(b);return c.o=b.o.bind(b),c.bind=b.bind.bind(b),c.toJSON=b.toJSON.bind(b),c};return function(){return f(d(arguments))}}(),q.fn.peek_last=function(a){return[a[0]]},q.fn.Ecriture=k(function(a){this.set_or_default(a,{mouvement:[],meta:{message:""},id:b}),this.meta=new o(this.meta),this.mouvement=this.mouvement.sort(function(a,b){var c=a[1].compare(b[1]);return 0!==c?c:a[1].compare(a[1].zero())<0?(a[0]-b[0])/Math.abs(a[0]-b[0]):(b[0]-a[0])/Math.abs(b[0]-a[0])})},{toVSON:function(){return{meta:this.meta,mouvement:this.mouvement.map(function(a){return[a[0],a[1].toJSON()]})}},o:function(a){return new q.fn.Ecriture({mouvement:this.mouvement.concat(a.mouvement),meta:this.meta.concat(a.meta)})}},n),q.fn.Compte=k(function(a){this.set_or_default(a,{journal:b,account:b,nom:"",subaccounts:b,id:b,$:b}),a.finit!==b&&a.finit instanceof Object&&(this.subaccounts=new this.$.Comptes([],this.$).first_root_init(a.finit),this.journal=new this.$.Journal({$:this.$}).id),this.id===b&&this.save()},{sigma:function(a){return this.lod("journal").cast(a).reduce(function(a,b){return a.add(b)},a.ZERO)},sub_sigma:function(a){return this.lod("subaccounts").sub_sigma(a)},is_parent_of:function(a){return 0===a.indexOf(this.account)},eq:function(a){return a===this.account},fragment:function(a){return new this.$.Fragment([[this.account,a(this)]])},find_and_map:function(a,b){var c=this,d=this.$.Fragment.prototype.maybe_empty,e=g(this.is_parent_of.bind(this),this.eq.bind(this))(a);return d(e.exact).bind(function(){return c.fragment(b)}).add(d(e.sub).bind(function(a){return c.lod("subaccounts").find_any(a,b)}))},diff:function(a){if(this.id===a.id)return[];var b=[];if(this.account!==a.account)throw new Exception("Y u duno compare different accounts ?");return this.journal!==a.journal&&(b=this.lod("journal").diff(a.lod("journal")).map(function(a){return[this.account,a]},this)),this.subaccounts.join(" ")===a.subaccounts.join(" ")?b:b.concat(this.lod("subaccounts").diff(a.lod("subaccounts")))},toJSON:function(){return{account:this.account,nom:this.nom,subaccounts:this.subaccounts,journal:this.journal}},toVSON:function(a){var b=this.sigma(a);return{account:this.account,nom:this.nom,subaccounts:this.lod("subaccounts").toVSON(a),data:b.toJSON(),solde:b.quotient().toJSON()}},mouvement:function(a){function b(a){return a[1]}var c;if(a=g(function(a){return this.is_parent_of(a[0])}.bind(this),function(a){return this.eq(a[0])}.bind(this))(a),0===a.exact.length&&0===a.sub.length)return!1;var d=a.exact.map(b),e=a.sub;return e.length>0&&(c=this.lod("subaccounts").mouvement({mouvement:e}),c||(d=d.concat(e.map(b)))),new this.$.Compte({journal:this.lod("journal").append(d).id,account:this.account,nom:this.nom,subaccounts:c||this.subaccounts,$:this.$})}},n),q.fn.Journal=k(function(a){this.set_or_default(a,{data:[],id:b,$:b}),this.id===b&&this.save()},{toJSON:function(){return{data:this.data.slice(0)}},append:function(a){return 0===a.length?this:new this.$.Journal({data:this.data.concat(a),$:this.$})},diff:function(a){return this.data.slice(a.data.length)},cast:function(a){return this.data.map(function(b){return new a(b)})}},n),q.fn.Comptes=k(function(a,b){[].push.apply(this,a),this.$=b},function(){return{lod:function(a){return this.$.sync("read",{id:a,$:this.$})},first_root_init:function(a){for(var b in a)switch(b){case"compte":case"mode":case"title":break;default:var c=a[""+b];this.push(new this.$.Compte({account:c.compte,nom:c.title,finit:c,$:this.$}).id)}return this.toJSON()},sub_sigma:function(a){return this.map(function(b){return b.sigma(a).add(b.sub_sigma(a))}.bind(this)).reduce(function(a,b){return a.add(b)},a.ZERO)},map:function(a){return[].map.call(this,function(a){return this.lod(a)}.bind(this)).map(a)},reduce:function(a,b){return[].map.call(this,function(a){return this.lod(a)}.bind(this)).reduce(a,b)},filter:function(a){return[].map.call(this,function(a){return this.lod(a)}.bind(this)).filter(a)},find_any:function(a,b){this.$;return this.map(function(b){return[b,a.filter(function(a){return 0===a.indexOf(b.account)})]}).filter(function(a){return a[1].length>0}).map(function(a){return a[0].find_and_map(a[1],b)}).reduce(function(a,b){return a.add(b)},new q.fn.Fragment([]))},mouvement:function(a){var c=(this.$,this.map(function(a){return[a.account,a]}));if(a=a.mouvement.map(function(a){return[a,c.filter(function(b){return 0===a[0].indexOf(b[0])})]}).filter(function(a){return 1===a[1].length}),0===a.length)return!1;var d={};a.forEach(function(a){var c=a[1][0][0];d[c]===b?d[c]={account:a[1][0][1],mouvement:[a[0]]}:d[c].mouvement.push(a[0])});for(var e in d)d[e]=d[e].account.mouvement(d[e].mouvement);var f=c.map(function(a){return d[a[0]]===b?a[1].id:d[a[0]].id});return new this.$.Comptes(f,this.$)},diff:function(a){if(this.length!==a.length)throw new Exception("y u duno comparing different arrays ?");return this.map(function(b,c){return b.diff(a.lod(a[c]))}).reduce(function(a,b){return a.concat(b)},[])},toJSON:function(){return e(this)},toVSON:function(a){return this.map(function(b){return b.toVSON(a)})},save:function(){this.$.sync("update",this,{success:function(){}})}}},Array),q.fn.Entite=k(function(a){this.set_or_default(a,{parents:b,nom:"acme",livre:b,mode:"abrege",fiche:{},tags:{},id:b,type:"DC",$:b}),this.tags=new o(this.tags),this.fiche=new o(this.fiche),this.livre===b&&(this.livre=new this.$.Livre({mode:this.mode,type:this.type,$:this.$}).id),this.id||(this.save(),this.$.update_ent(this))},{toJSON:function(){return{parents:this.parents,nom:this.nom,mode:this.mode,fiche:this.fiche,livre:this.livre,type:this.type,tags:this.tags}},toVSON:function(){var a=this.toJSON();return a.livre=this.lod("livre").toVSON(),a.meta=this.log().meta,a},tag:function(a){return this.lod(this.tags[a])},set_tag:function(a,b){var c={};return c[a]=b||this.livre,new q.fn.Entite({parents:[this.id],nom:this.nom,livre:this.livre,mode:this.mode,fiche:this.fiche,tags:this.tag.concat(c),type:this.type,$:this.$})},commit:function(a){return new q.fn.Entite({parents:[this.id],nom:this.nom,livre:this.lod("livre").commit(a).id,mode:this.mode,fiche:this.fiche,tags:this.tags,type:this.type,$:this.$})},log:function(){return this.lod("livre").log()},checkout:function(a){var c=this.lod(a||this.livre);return c instanceof this.$.Livre?c:b},history:function(){return this.lod("livre").history()},back:function(a){return 0===a?this:this.parents===b?this:this.lod(this.parents[0]).back(a-1)},diff:function(a){if(a instanceof this.$.Livre||(a instanceof String&&(a=this.lod(a)),a instanceof this.$.Entite&&(a=this.lod(a.livre))),a instanceof this.$.Livre)return this.lod("livre").diff(a);throw new TypeError("id must be an Livre or Entity")}},n),q.fn.update_ent=function(a){this.save(function(){this.entities[a.nom]=a.id})},q.fn.entity=function(a,b){return b=b||{},b.mode=b.mode||"abrege",this.entities[a]=this.entities[a]||{},this.entities[a]?this.sync("read",{id:this.entities[a]}):this.save(function(){console.log(this.set_or_default.call({nom:a,$:this},{},b));var c=new this.Entite({nom:a,$:this});return this.entities[a]=c.id,c})},q.fn.Livre=k(function(a){this.set_or_default(a,{accounts:b,parents:b,meta:{message:""},id:b,type:"DC",$:b}),this.meta=new o(this.meta),a.mode&&(this.meta.message="mise à zéro",this.accounts=new this.$.Comptes([],this.$).first_root_init(i[a.mode])),this.id===b&&this.save()},{toJSON:function(){return{parents:this.parents,meta:this.meta,type:this.type,accounts:this.accounts}},toVSON:function(){var a=this.toJSON();return a.accounts=this.lod("accounts").toVSON(this.$[this.type]),a},commit:function(a){return new this.$.Livre({accounts:this.lod("accounts").mouvement(a),parents:[this.id],meta:a.meta,type:this.type,$:this.$})},back:function(a){return 0===a?this:this.parents===b?this:this.lod(this.parents[0]).back(a-1)},log:function(){return{id:this.id,parents:this.parents,meta:this.meta}},history:function(){for(var a=this,b=[a.log()];a.back(1)!==a;)a=a.back(1),b.push(a.log());return b},checkout:function(a){var c=this.lod(a||this.id);return c instanceof this.$.Livre?c:b},diff:function(a){var b,c=this.$[this.type];return a instanceof this.$.Livre?b=a:(b=this.lod(a),console.log([a,b])),new this.$.Ecriture(this.id===b.id?{mouvement:[],meta:{message:""}}:{mouvement:this.lod("accounts").diff(b.lod("accounts")).map(function(a){return[a[0],new c(a[1])]}),meta:this.meta})},find_any_and_map:function(a,b){return this.lod("accounts").find_any(a,b.bind(null,this.$[this.type]))},s_etat:function(){var a=d(arguments),b=function(a,c){return new c.$.Fragment([[c.account,c.sigma(a).quotient()]]).add(c.lod("subaccounts").map(b).reduce(function(a,b){return a.add(b)},new q.fn.Fragment))}.bind(null,this.$[this.type]);return this.lod("accounts").map(function(b){return[b,a.filter(function(a){return 0===a.indexOf(b.account)}).length]}).filter(function(a){return a[1]>0}).map(function(a){return a[0]}).map(b).reduce(function(a,b){return a.add(b)},new q.fn.Fragment)},etat:function(){return this.find_any_and_map(d(arguments),function(a,b){return b.sigma(a)})},r_etat:function(){return this.find_any_and_map(d(arguments),function(a,b){return b.sigma(a).add(b.sub_sigma(a))})}},n),["Comptes","Compte","Ecriture","Journal","Livre","Entite","Operation"].forEach(function(a){h[a]=q.fn[a]}),a.$fi=new q,a.$fi.fn=q.prototype}(window);